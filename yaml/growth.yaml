steps:
  - id: begin
    visible: false
    check:
      script:
        db: drupal
        snippets:
            - set_email_var
    delete:
      script:
        db: drupal
        snippets:
          - set_request_number
          - set_user_id
          - compose_email_placeholder
          - compose_text_placeholder
  - id: email
    check:
      description: >
        check if the email is in users table in bidata DB
      choices:
        - yes
        - no
      script:
        db: drupal
        snippets:
          - find_user_id
          - show_user_id
    delete:
      description: >
        create sql to "delete" in users table
      script:
        db: drupal
        snippets:
          - update_placeholder_in_users
types:
  - check
  - delete
db:
  - drupal
  - sessions
  - di
  - jobs
  - di_jobs
vars:
  email:
    description: >
      email address from OneTrust
  requestNumber:
    description: >
      request number from OneTrust
  userId:
    description: >
      user id from the main drupal database
  emailPlaceholder:
    description: >
      placeholder to replace email reference
  textPlaceholder:
    description: >
      placeholder to replace text reference
snippets:
  set_email_var: |
    set @email = {{email}};
  find_user_id: |
    select uid into @UID from users where mail = @email;
  show_user_id: |
    select @UID;
  set_request_number: |
    set @requestnumber = {{requestNumber}};
  set_user_id: |
    set @UID = {{userId}};
  compose_email_placeholder: |
    select concat("deleted-onetrust-req-", @requestnumber, "@privacy.mntd.net") into @emailplaceholder;
  compose_text_placeholder: |
    select concat("Deleted per onetrust", @requestnumber) into @textplaceholder;
  update_placeholder_in_users: |
    update users
    set
    name = @textplaceholder,
    init = @textplaceholder,
    mail = @emailplaceholder,
    pass = textplaceholder,
    where uid = @UID;